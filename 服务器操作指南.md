# æœåŠ¡å™¨æ“ä½œæŒ‡å— - æ•°æ®åº“æ›´æ–°

## ğŸ“‹ å½“å‰æƒ…å†µ

ä½ åˆšæ‰æ·»åŠ äº†ï¼š
- âœ… ä¼šå‘˜ç§¯åˆ†ç³»ç»Ÿï¼ˆæ–°å¢9ä¸ªæ•°æ®åº“è¡¨ï¼‰
- âœ… æ•°æ®åº“æ¨¡æ¿
- âœ… å„ç§æ–°åŠŸèƒ½

ç­‰ç½‘ç»œæ¢å¤åï¼Œä»£ç ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨ã€‚

---

## ğŸ”§ æœåŠ¡å™¨éœ€è¦åšä»€ä¹ˆï¼Ÿ

### æƒ…å†µ1ï¼šæœåŠ¡å™¨å·²æœ‰æ—§æ•°æ®åº“ï¼ˆæ¨èï¼‰

å¦‚æœæœåŠ¡å™¨ä¸Šçš„ `messages.db` å·²ç»åœ¨è¿è¡Œï¼Œ**åªéœ€æ›´æ–°æ•°æ®åº“ç»“æ„**ï¼š

```bash
# SSHè¿æ¥æœåŠ¡å™¨
ssh root@47.107.42.77

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/maycoffee

# ç­‰å¾…è‡ªåŠ¨åŒæ­¥å®Œæˆæˆ–æ‰‹åŠ¨æ‹‰å–
git pull

# ã€é‡è¦ã€‘æ›´æ–°æ•°æ®åº“ç»“æ„ï¼ˆæ·»åŠ æ–°è¡¨ï¼‰
python3 << 'EOF'
from app import app, db
with app.app_context():
    db.create_all()
    print("âœ… æ•°æ®åº“ç»“æ„å·²æ›´æ–°")
EOF

# æ·»åŠ å…‘æ¢å•†å“ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰ï¼‰
python3 init_redemption_items.py

# é‡å¯æœåŠ¡
sudo systemctl restart maycoffee

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status maycoffee
```

**ä¼˜ç‚¹ï¼š**
- âœ… ä¿ç•™æ‰€æœ‰ç°æœ‰æ•°æ®ï¼ˆç•™è¨€ã€ç”¨æˆ·ç­‰ï¼‰
- âœ… åªæ·»åŠ æ–°è¡¨
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½

---

### æƒ…å†µ2ï¼šæœåŠ¡å™¨æ˜¯æ–°çš„/æƒ³é‡æ–°å¼€å§‹

å¦‚æœæƒ³ä»å¤´å¼€å§‹ï¼š

```bash
# SSHè¿æ¥æœåŠ¡å™¨
ssh root@47.107.42.77

cd /var/www/maycoffee

# å¤‡ä»½æ—§æ•°æ®åº“ï¼ˆå¦‚æœæœ‰ï¼‰
if [ -f messages.db ]; then
    cp messages.db messages_backup_$(date +%Y%m%d_%H%M%S).db
    echo "âœ… å·²å¤‡ä»½æ—§æ•°æ®åº“"
fi

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# ä½¿ç”¨æ¨¡æ¿åˆå§‹åŒ–æ•°æ®åº“
cp database_template.db messages.db

# é‡å¯æœåŠ¡
sudo systemctl restart maycoffee

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status maycoffee
```

---

## ğŸ¯ æ¨èæ“ä½œï¼ˆæœ€å®‰å…¨ï¼‰

### ç¬¬1æ­¥ï¼šæ£€æŸ¥å½“å‰çŠ¶æ€

```bash
ssh root@47.107.42.77
cd /var/www/maycoffee

# æŸ¥çœ‹å½“å‰ä»£ç ç‰ˆæœ¬
git log --oneline -5

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status maycoffee

# æŸ¥çœ‹æ•°æ®åº“æ˜¯å¦å­˜åœ¨
ls -lh messages.db
```

### ç¬¬2æ­¥ï¼šæ›´æ–°æ•°æ®åº“ç»“æ„ï¼ˆä¿ç•™æ•°æ®ï¼‰

```bash
# åˆ›å»ºæ›´æ–°è„šæœ¬
cat > update_database.py << 'EOF'
#!/usr/bin/env python3
from app import app, db

print("å¼€å§‹æ›´æ–°æ•°æ®åº“ç»“æ„...")

with app.app_context():
    # åˆ›å»ºæ‰€æœ‰è¡¨ï¼ˆä¸å­˜åœ¨çš„ä¼šè¢«åˆ›å»ºï¼Œå·²å­˜åœ¨çš„ä¸å—å½±å“ï¼‰
    db.create_all()
    print("âœ… æ•°æ®åº“ç»“æ„å·²æ›´æ–°")
    
    # æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    from sqlalchemy import inspect
    inspector = inspect(db.engine)
    tables = inspector.get_table_names()
    
    print(f"\nå½“å‰æ•°æ®åº“åŒ…å« {len(tables)} ä¸ªè¡¨:")
    for table in tables:
        print(f"  - {table}")

print("\nâœ¨ æ›´æ–°å®Œæˆ!")
EOF

# æ‰§è¡Œæ›´æ–°
python3 update_database.py

# å¦‚æœæ²¡æœ‰å…‘æ¢å•†å“ï¼Œæ·»åŠ ç¤ºä¾‹å•†å“
python3 init_redemption_items.py
```

### ç¬¬3æ­¥ï¼šé‡å¯æœåŠ¡

```bash
sudo systemctl restart maycoffee
sudo systemctl status maycoffee

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u maycoffee -n 50 --no-pager
```

### ç¬¬4æ­¥ï¼šæµ‹è¯•ç½‘ç«™

```bash
# è®¿é—®ç½‘ç«™æµ‹è¯•
curl http://localhost:5000/

# æµ‹è¯•ä¼šå‘˜API
curl http://localhost:5000/api/member/info
```

---

## ğŸ“Š æ•°æ®åº“è¡¨æ¸…å•

æ‰§è¡Œæ›´æ–°åï¼Œæ•°æ®åº“åº”è¯¥åŒ…å«è¿™äº›è¡¨ï¼š

**åŸæœ‰çš„è¡¨ï¼š**
1. message - ç•™è¨€è¡¨
2. reply - å›å¤è¡¨

**æ–°å¢çš„è¡¨ï¼ˆä¼šå‘˜ç³»ç»Ÿï¼‰ï¼š**
3. member - ä¼šå‘˜è¡¨
4. point_record - ç§¯åˆ†è®°å½•è¡¨
5. redemption_item - å…‘æ¢å•†å“è¡¨
6. redemption - å…‘æ¢è®°å½•è¡¨
7. check_in - ç­¾åˆ°è®°å½•è¡¨
8. invitation - é‚€è¯·è®°å½•è¡¨
9. password_reset_token - å¯†ç é‡ç½®ä»¤ç‰Œè¡¨

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: æ‰§è¡Œ db.create_all() ä¼šåˆ é™¤æ•°æ®å—ï¼Ÿ

**A:** ä¸ä¼šï¼`create_all()` åªåˆ›å»ºä¸å­˜åœ¨çš„è¡¨ï¼Œä¸ä¼šå½±å“å·²æœ‰çš„è¡¨å’Œæ•°æ®ã€‚

### Q2: å¦‚æœå‡ºé”™æ€ä¹ˆåŠï¼Ÿ

**A:** å…ˆå¤‡ä»½æ•°æ®åº“ï¼š
```bash
cp messages.db messages_backup.db
```

### Q3: å¦‚ä½•ç¡®è®¤æ›´æ–°æˆåŠŸï¼Ÿ

**A:** è¿è¡Œæ£€æŸ¥è„šæœ¬ï¼š
```python
python3 << 'EOF'
from app import app, db
from sqlalchemy import inspect

with app.app_context():
    inspector = inspect(db.engine)
    tables = inspector.get_table_names()
    
    expected_tables = [
        'message', 'reply', 'member', 'point_record', 
        'redemption_item', 'redemption', 'check_in', 
        'invitation', 'password_reset_token'
    ]
    
    print("æ£€æŸ¥æ•°æ®åº“è¡¨...")
    for table in expected_tables:
        status = "âœ…" if table in tables else "âŒ"
        print(f"{status} {table}")
    
    if all(t in tables for t in expected_tables):
        print("\nğŸ‰ æ‰€æœ‰è¡¨éƒ½å·²æ­£ç¡®åˆ›å»º!")
    else:
        print("\nâš ï¸  æœ‰äº›è¡¨ç¼ºå¤±ï¼Œè¯·é‡æ–°è¿è¡Œ db.create_all()")
EOF
```

### Q4: éœ€è¦é‡å¯WebhookæœåŠ¡å—ï¼Ÿ

**A:** ä¸éœ€è¦ã€‚WebhookæœåŠ¡åªè´Ÿè´£æ‹‰å–ä»£ç ï¼Œä¸æ¶‰åŠæ•°æ®åº“ã€‚

---

## ğŸ”„ å®Œæ•´çš„æ›´æ–°æµç¨‹æ€»ç»“

```bash
# 1. è¿æ¥æœåŠ¡å™¨
ssh root@47.107.42.77

# 2. è¿›å…¥ç›®å½•
cd /var/www/maycoffee

# 3. å¤‡ä»½æ•°æ®åº“ï¼ˆå®‰å…¨ç¬¬ä¸€ï¼‰
cp messages.db messages_backup_$(date +%Y%m%d).db

# 4. æ‹‰å–æœ€æ–°ä»£ç ï¼ˆæˆ–ç­‰è‡ªåŠ¨åŒæ­¥ï¼‰
git pull

# 5. æ›´æ–°æ•°æ®åº“ç»“æ„
python3 -c "from app import app, db; app.app_context().push(); db.create_all(); print('âœ… å®Œæˆ')"

# 6. æ·»åŠ å…‘æ¢å•†å“ï¼ˆå¦‚æœéœ€è¦ï¼‰
python3 init_redemption_items.py

# 7. é‡å¯æœåŠ¡
sudo systemctl restart maycoffee

# 8. æ£€æŸ¥çŠ¶æ€
sudo systemctl status maycoffee

# 9. æŸ¥çœ‹æ—¥å¿—ï¼ˆç¡®ä¿æ²¡æœ‰é”™è¯¯ï¼‰
sudo journalctl -u maycoffee -n 20 --no-pager

# å®Œæˆï¼ğŸ‰
```

---

## ğŸ’¾ æ•°æ®åº“å¤‡ä»½ï¼ˆé‡è¦ï¼ï¼‰

åœ¨åšä»»ä½•æ“ä½œå‰ï¼Œå»ºè®®è®¾ç½®è‡ªåŠ¨å¤‡ä»½ï¼š

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /var/www/maycoffee/backup_db.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/var/www/maycoffee/backups"
mkdir -p $BACKUP_DIR
cp /var/www/maycoffee/messages.db $BACKUP_DIR/messages_$(date +%Y%m%d).db
find $BACKUP_DIR -name "messages_*.db" -mtime +7 -delete
echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ: $(date)"
EOF

chmod +x /var/www/maycoffee/backup_db.sh

# è®¾ç½®æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨å¤‡ä»½
(crontab -l 2>/dev/null; echo "0 3 * * * /var/www/maycoffee/backup_db.sh") | crontab -

# æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡æµ‹è¯•
/var/www/maycoffee/backup_db.sh
```

---

## ğŸ‰ æ€»ç»“

**æœ€ç®€å•å®‰å…¨çš„æ“ä½œï¼š**

```bash
# ä¸€æ¡å‘½ä»¤æå®šï¼ˆç­‰ç½‘ç»œæ¢å¤åï¼‰
ssh root@47.107.42.77 'cd /var/www/maycoffee && cp messages.db messages_backup.db && git pull && python3 -c "from app import app, db; app.app_context().push(); db.create_all()" && python3 init_redemption_items.py && sudo systemctl restart maycoffee && sudo systemctl status maycoffee'
```

æˆ–è€…åˆ†æ­¥éª¤æ‰§è¡Œï¼ˆæ›´æ¸…æ¥šï¼‰ï¼š
1. SSHç™»å½•
2. å¤‡ä»½æ•°æ®åº“
3. æ‹‰å–ä»£ç 
4. æ›´æ–°æ•°æ®åº“ç»“æ„
5. æ·»åŠ å•†å“
6. é‡å¯æœåŠ¡

**å°±è¿™ä¹ˆç®€å•ï¼** âœ¨
