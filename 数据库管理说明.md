# 数据库管理说明

## 当前配置

数据库文件（messages.db）**不会**从本地上传到GitHub。

### 文件位置
- 本地：有数据库但被.gitignore忽略
- GitHub：不包含数据库文件
- 服务器：需要单独创建和维护

## 工作流程

### 1. 本地开发
本地的数据库只用于测试，不会上传：
```bash
# 本地运行Flask会自动创建数据库
python3 app.py
# 数据库文件: messages.db（仅本地使用）
```

### 2. 服务器数据库

**首次部署时**，在服务器上手动初始化数据库：
```bash
# SSH连接到服务器
ssh root@47.107.42.77

# 进入项目目录
cd /var/www/maycoffee

# 初始化数据库（如果不存在）
python3 -c "from app import app, db; app.app_context().push(); db.create_all(); print('数据库创建成功')"

# 初始化兑换商品
python3 init_redemption_items.py

# 重启服务
sudo systemctl restart maycoffee
```

### 3. 数据库备份（重要！）

由于数据库不在Git中，需要定期备份服务器数据库：

```bash
# 在服务器上创建备份目录
mkdir -p /var/www/maycoffee/backups

# 手动备份
cp /var/www/maycoffee/messages.db /var/www/maycoffee/backups/messages_$(date +%Y%m%d_%H%M%S).db

# 或者设置定时备份（每天凌晨3点）
echo "0 3 * * * cp /var/www/maycoffee/messages.db /var/www/maycoffee/backups/messages_\$(date +\%Y\%m\%d).db" | crontab -
```

## 注意事项

### ✅ 优点
- 本地测试数据不会污染生产数据
- 可以随意在本地测试，不用担心上传错误数据
- 服务器数据独立管理，更安全

### ⚠️ 注意
1. **服务器数据库是唯一的生产数据**
2. **必须定期备份服务器数据库**
3. **代码更新不会影响数据库数据**
4. **但数据库结构变更需要手动迁移**

## 数据库结构更新

如果app.py中添加了新的数据库模型，需要在服务器上更新：

```bash
# 方法1: 简单但会清空数据（不推荐生产环境）
# 删除旧数据库
rm /var/www/maycoffee/messages.db
# 重新创建
python3 -c "from app import app, db; app.app_context().push(); db.create_all()"

# 方法2: 使用Flask-Migrate（推荐）
# 需要先安装: pip install flask-migrate
# 然后可以做数据库迁移
```

## 当前数据库表

- Message: 留言表
- Reply: 回复表
- Member: 会员表
- PointRecord: 积分记录表
- RedemptionItem: 兑换商品表
- Redemption: 兑换记录表
- CheckIn: 签到记录表
- Invitation: 邀请记录表
- PasswordResetToken: 密码重置令牌表

## 快速命令

### 查看服务器数据库大小
```bash
ls -lh /var/www/maycoffee/messages.db
```

### 下载服务器数据库到本地（用于备份）
```bash
scp root@47.107.42.77:/var/www/maycoffee/messages.db ./messages_backup.db
```

### 清空本地测试数据库
```bash
rm messages.db
rm instance/messages.db
# 重新运行Flask会自动创建新的空数据库
```

## 总结

✅ **你的配置已经正确！**
- 本地：数据库被忽略，不会上传
- GitHub：只有代码，没有数据库
- 服务器：需要单独维护数据库

📝 **下次部署流程：**
1. 本地修改代码
2. git push 到GitHub（不包含数据库）
3. 服务器自动拉取代码更新
4. 服务器的数据库不受影响，数据保留

⚠️ **记得备份服务器数据库！**
