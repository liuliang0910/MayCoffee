<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的会员中心 - 五月咖啡 MayCoffee</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .member-header {
            background: linear-gradient(135deg, #a37e58 0%, #d4a574 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-radius: 12px;
            margin: 30px 0;
        }

        .member-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .member-level {
            display: inline-block;
            padding: 6px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 14px;
        }

        .points-display {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0 10px 0;
        }

        .tabs-nav {
            display: flex;
            gap: 10px;
            margin: 30px 0 20px 0;
            border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap;
        }

        .tabs-nav button {
            padding: 12px 24px;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tabs-nav button.active {
            color: #a37e58;
            border-bottom-color: #a37e58;
            font-weight: bold;
        }

        .tab-panel {
            display: none;
            padding: 20px 0;
        }

        .tab-panel.active {
            display: block;
        }

        .records-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .record-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-points {
            font-size: 20px;
            font-weight: bold;
        }

        .record-points.positive {
            color: #28a745;
        }

        .record-points.negative {
            color: #dc3545;
        }

        .record-reason {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .record-date {
            color: #999;
            font-size: 12px;
        }

        .redemption-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .redemption-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .redemption-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .redemption-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .redemption-card h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #333;
        }

        .redemption-card p {
            color: #666;
            font-size: 14px;
            margin: 0 0 15px 0;
        }

        .redemption-points {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .points-required {
            font-size: 24px;
            font-weight: bold;
            color: #a37e58;
        }

        .stock-info {
            color: #999;
            font-size: 12px;
        }

        .redeem-btn {
            width: 100%;
            padding: 10px;
            background: #a37e58;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .redeem-btn:hover:not(:disabled) {
            background: #8a6a4a;
        }

        .redeem-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .redemption-history-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .redemption-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .logout-btn {
            padding: 10px 24px;
            background: white;
            color: #a37e58;
            border: 2px solid white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: transparent;
            color: white;
        }

        .empty-message {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-message img {
            width: 100px;
            opacity: 0.3;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="container">
            <div class="logo">
                <a href="index.html"><img src="images/1_主logo/五月咖啡 主LOGO 透明背景.svg" alt="五月咖啡 MayCoffee Logo"></a>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">首页</a></li>
                    <li><a href="menu.html">产品菜单</a></li>
                    <li><a href="about.html">关于我们</a></li>
                    <li><a href="contact.html">联系我们</a></li>
                    <li><a href="feedback.html">客户留言</a></li>
                    <li><a href="member-center.html">会员中心</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- 会员头部 -->
        <div class="member-header">
            <h1 id="memberName">加载中...</h1>
            <span class="member-level" id="memberLevel">普通会员</span>
            <div class="points-display" id="memberPoints">0</div>
            <div>我的积分</div>
            <button class="logout-btn" onclick="logout()">退出登录</button>
        </div>

        <!-- 标签导航 -->
        <div class="tabs-nav">
            <button class="active" onclick="switchTab('points')">积分记录</button>
            <button onclick="switchTab('redemption')">积分商城</button>
            <button onclick="switchTab('history')">兑换记录</button>
        </div>

        <!-- 积分记录 -->
        <div id="points-panel" class="tab-panel active">
            <div class="records-list" id="pointsRecordsList">
                <div class="empty-message">加载中...</div>
            </div>
        </div>

        <!-- 积分商城 -->
        <div id="redemption-panel" class="tab-panel">
            <div class="redemption-grid" id="redemptionItemsList">
                <div class="empty-message">加载中...</div>
            </div>
        </div>

        <!-- 兑换记录 -->
        <div id="history-panel" class="tab-panel">
            <div id="redemptionHistoryList">
                <div class="empty-message">加载中...</div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 五月咖啡 MayCoffee. 版权所有.</p>
            <div class="beian-info">
                <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备2025493201号-1</a>
            </div>
        </div>
    </footer>

    <script>
        let currentMember = null;

        // 页面加载时检查登录状态
        window.addEventListener('DOMContentLoaded', async () => {
            await loadMemberInfo();
            await loadPointsRecords();
            await loadRedemptionItems();
            await loadRedemptionHistory();
        });

        // 加载会员信息
        async function loadMemberInfo() {
            try {
                const response = await fetch('/api/member/info');
                const result = await response.json();
                
                if (result.success) {
                    currentMember = result.member;
                    document.getElementById('memberName').textContent = result.member.username;
                    document.getElementById('memberLevel').textContent = result.member.level;
                    document.getElementById('memberPoints').textContent = result.member.points;
                } else {
                    // 未登录,跳转到登录页面
                    window.location.href = 'member.html';
                }
            } catch (error) {
                console.error('加载会员信息失败:', error);
                window.location.href = 'member.html';
            }
        }

        // 加载积分记录
        async function loadPointsRecords() {
            try {
                const response = await fetch('/api/member/points/records');
                const result = await response.json();
                
                const container = document.getElementById('pointsRecordsList');
                
                if (result.success && result.records.length > 0) {
                    container.innerHTML = result.records.map(record => `
                        <div class="record-item">
                            <div>
                                <div class="record-reason">${record.reason}</div>
                                <div class="record-date">${record.created_at}</div>
                            </div>
                            <div class="record-points ${record.points > 0 ? 'positive' : 'negative'}">
                                ${record.points > 0 ? '+' : ''}${record.points}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-message">暂无积分记录</div>';
                }
            } catch (error) {
                console.error('加载积分记录失败:', error);
            }
        }

        // 加载兑换商品
        async function loadRedemptionItems() {
            try {
                const response = await fetch('/api/redemption/items');
                const result = await response.json();
                
                const container = document.getElementById('redemptionItemsList');
                
                if (result.success && result.items.length > 0) {
                    container.innerHTML = result.items.map(item => {
                        const canRedeem = currentMember && currentMember.points >= item.points_required && item.stock > 0;
                        return `
                            <div class="redemption-card">
                                <img src="${item.image || 'https://via.placeholder.com/250x150?text=商品图片'}" alt="${item.name}">
                                <h3>${item.name}</h3>
                                <p>${item.description || '暂无描述'}</p>
                                <div class="redemption-points">
                                    <span class="points-required">${item.points_required} 积分</span>
                                    <span class="stock-info">库存: ${item.stock}</span>
                                </div>
                                <button class="redeem-btn" 
                                        onclick="redeemItem(${item.id})" 
                                        ${!canRedeem ? 'disabled' : ''}>
                                    ${canRedeem ? '立即兑换' : (item.stock <= 0 ? '已售罄' : '积分不足')}
                                </button>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="empty-message">暂无兑换商品</div>';
                }
            } catch (error) {
                console.error('加载兑换商品失败:', error);
            }
        }

        // 加载兑换记录
        async function loadRedemptionHistory() {
            try {
                const response = await fetch('/api/member/redemptions');
                const result = await response.json();
                
                const container = document.getElementById('redemptionHistoryList');
                
                if (result.success && result.redemptions.length > 0) {
                    container.innerHTML = result.redemptions.map(redemption => `
                        <div class="redemption-history-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <h3 style="margin: 0 0 5px 0;">${redemption.item.name}</h3>
                                    <div class="record-date">${redemption.created_at}</div>
                                </div>
                                <span class="redemption-status ${redemption.status === '已领取' ? 'status-completed' : 'status-pending'}">
                                    ${redemption.status}
                                </span>
                            </div>
                            <div style="color: #666;">消耗积分: <strong>${redemption.points_spent}</strong></div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-message">暂无兑换记录</div>';
                }
            } catch (error) {
                console.error('加载兑换记录失败:', error);
            }
        }

        // 切换标签页
        function switchTab(tab) {
            // 切换按钮状态
            document.querySelectorAll('.tabs-nav button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 切换内容
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${tab}-panel`).classList.add('active');
        }

        // 兑换商品
        async function redeemItem(itemId) {
            if (!confirm('确认要兑换这个商品吗?')) {
                return;
            }

            try {
                const response = await fetch('/api/redemption/redeem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    // 重新加载数据
                    await loadMemberInfo();
                    await loadPointsRecords();
                    await loadRedemptionItems();
                    await loadRedemptionHistory();
                } else {
                    alert(result.error || '兑换失败');
                }
            } catch (error) {
                alert('网络错误,请重试');
            }
        }

        // 退出登录
        async function logout() {
            if (!confirm('确认要退出登录吗?')) {
                return;
            }

            try {
                await fetch('/api/member/logout', { method: 'POST' });
                window.location.href = 'member.html';
            } catch (error) {
                console.error('退出登录失败:', error);
            }
        }
    </script>

</body>
</html>
